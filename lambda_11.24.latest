import json
import logging
import boto3
import urllib3
import os
import re
from botocore.config import Config
from datetime import datetime, timedelta
from urllib3.util.retry import Retry
from boto3.dynamodb.conditions import Key

# ë¡œê¹… ì„¤ì •
logger = logging.getLogger()
logger.setLevel(logging.INFO)

# HTTP í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
http = urllib3.PoolManager(
    maxsize=50,
    retries=Retry(
        total=3,
        backoff_factor=1,
        status_forcelist=[500, 502, 503, 504],
        allowed_methods=["POST"]
    ),
    timeout=30.0
)

# AWS ì„¤ì •
boto_config = Config(
    retries={'max_attempts': 3, 'mode': 'adaptive'},
    max_pool_connections=50
)
dynamodb = boto3.resource('dynamodb', config=boto_config)
sessions_table = dynamodb.Table('chatbot_sessions')
completed_sessions_table = dynamodb.Table('chatbot_completed_sessions')  # ì™„ë£Œëœ ì„¸ì…˜ ì €ì¥ìš©

# ì½”ì¹­ ë‹¨ê³„ ì •ì˜
COACHING_STAGES = [
    "ì‹ ë¢° í˜•ì„±",
    "í˜„ì‹¤ íƒìƒ‰",
    "ëª©í‘œ ì„¤ì •",
    "ëŒ€ì•ˆ íƒìƒ‰", 
    "ì‹¤í–‰ ê³„íš",
    "ì •ë¦¬ ë° ë§ˆë¬´ë¦¬"
]

# ì„¸ì…˜ ë¦¬ì…‹ í‚¤ì›Œë“œ íŒ¨í„´
RESET_PATTERNS = [
    r'ë‹¤ì‹œ\s*ì‹œì‘',
    r'ì²˜ìŒë¶€í„°',
    r'ìƒˆë¡œ\s*ì‹œì‘',
    r'ë¦¬ì…‹',
    r'reset',
    r'restart',
    r'ë‹¤ì‹œ\s*í•´',
    r'ìƒˆë¡œ\s*í•´',
    r'ì½”ì¹­\s*ë‹¤ì‹œ',
    r'ì²˜ìŒìœ¼ë¡œ'
]

# ì¢…ë£Œ í‚¤ì›Œë“œ íŒ¨í„´
END_PATTERNS = [
    r'ì¢…ë£Œ',
    r'ë',
    r'ê·¸ë§Œ',
    r'stop',
    r'exit',
    r'quit',
    r'ì½”ì¹­\s*ë',
    r'ë§ˆë¬´ë¦¬',
    r'ê·¸ë§Œ\s*í•˜',
]

# ì¬ê°œ í™•ì¸ í‚¤ì›Œë“œ
CONTINUE_PATTERNS = [
    r'ê³„ì†',
    r'ì´ì–´ì„œ',
    r'continue',
    r'ë„¤',
    r'yes',
    r'ì¢‹ì•„',
    r'ê³„ì†í• ê²Œ'
]

NEW_SESSION_PATTERNS = [
    r'ìƒˆë¡œ',
    r'ë‹¤ì‹œ',
    r'ìƒˆ\s*ì£¼ì œ',
    r'new',
    r'ì•„ë‹ˆ',
    r'no',
    r'ë‹¤ë¥¸'
]

# ìœ„ê¸° í‚¤ì›Œë“œ íŒ¨í„´
CRISIS_PATTERNS = [
    r'ìí•´', r'ìì‚´', r'ì£½ê³ \s*ì‹¶', r'ì‚¬ë¼ì§€ê³ \s*ì‹¶',
    r'í­ë ¥', r'í•™ëŒ€', r'ê´´ë¡­í˜', r'ì™•ë”°', r'ë•Œë¦¬', r'ë§ì•„',
    r'í˜¼ì', r'ì™¸ë¡œì›Œ', r'ì•„ë¬´ë„\s*ì—†'
]

# ë‹¨ê³„ë³„ í”„ë¡¬í”„íŠ¸ ì •ì˜ (ë„ì›€ìš”ì²­ ì£¼ì œ íŠ¹í™”)
STAGE_PROMPTS = {
    "ì‹ ë¢° í˜•ì„±": """
ë‹¹ì‹ ì€ í•™ìƒë“¤ì˜ ë§ˆìŒì„ ì´í•´í•˜ëŠ” AI ì½”ì¹˜ì…ë‹ˆë‹¤. ì§€ê¸ˆì€ 'ì‹ ë¢° í˜•ì„±' ë‹¨ê³„ì…ë‹ˆë‹¤.
ì´ ë‹¨ê³„ì—ì„œëŠ” í•™ìƒê³¼ì˜ í¸ì•ˆí•œ ê´€ê³„ë¥¼ í˜•ì„±í•˜ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.

ë‹¤ìŒ ì›ì¹™ì„ ë”°ë¼ì£¼ì„¸ìš”:
1. í•™ìƒì„ ë”°ëœ»í•˜ê²Œ í™˜ì˜í•˜ê³  í¸ì•ˆí•œ ë¶„ìœ„ê¸°ë¥¼ ë§Œë“œì„¸ìš”
2. í•™ìƒì˜ í˜„ì¬ ìƒíƒœ(ê°ì •, ìƒê°)ì— ê´€ì‹¬ì„ ë³´ì´ì„¸ìš”
3. ì¹œê·¼í•˜ê³  í¸ì•ˆí•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ë˜, ì¡´ëŒ“ë§ì„ ìœ ì§€í•˜ì„¸ìš”
4. í•™êµ ìƒí™œê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ì„ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨í•˜ì„¸ìš”
5. íŒë‹¨í•˜ì§€ ì•Šê³  ìˆ˜ìš©ì ì¸ íƒœë„ë¥¼ ë³´ì´ì„¸ìš”

âš ï¸ ë§¤ìš° ì¤‘ìš”í•œ ê·œì¹™ë“¤:
- ë°˜ë“œì‹œ í•œ ë²ˆì— ë‹¨ í•˜ë‚˜ì˜ ì§ˆë¬¸ë§Œ í•˜ì„¸ìš”!
- ì ˆëŒ€ ë‘ ê°œ ì´ìƒì˜ ì§ˆë¬¸ì„ ì—°ì†ìœ¼ë¡œ í•˜ì§€ ë§ˆì„¸ìš”
- "(í•™ìƒì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤)" ê°™ì€ ë©”íƒ€ í‘œí˜„ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
- í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚´ê³ , í•™ìƒì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”
- ì„¤ëª…, ì¡°ì–¸, ì˜ˆì‹œ, í•´ê²°ì±… ì œì‹œëŠ” í•˜ì§€ ë§ˆì„¸ìš”
- í•™ìƒì´ ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ í•˜ë“  ê·¸ê²ƒë¶€í„° ê³µê°í•˜ê³  ë°›ì•„ë“¤ì´ì„¸ìš”

{previous_context}

ì´ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ ì˜ˆì‹œ (í•˜ë‚˜ë§Œ ì„ íƒ):
- ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë• ë‚˜ìš”?
- ìš”ì¦˜ í•™êµìƒí™œì€ ì–´ë–¤ê°€ìš”?
- ì§€ê¸ˆ ê¸°ë¶„ì´ ì–´ë–¤ê°€ìš”?
- ì˜¤ëŠ˜ ì´ ì‹œê°„ì— ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ê³  ì‹¶ë‚˜ìš”?
- ìµœê·¼ì— ë§ˆìŒì— ê±¸ë¦¬ëŠ” ì¼ì´ ìˆë‚˜ìš”?

í•™ìƒì´ ë¨¼ì € ë‹¤ë¥¸ ì£¼ì œ(í™”ì¥ì‹¤, ì§œì¦ë‚œ ì¼ ë“±)ë¥¼ ì´ì•¼ê¸°í•˜ë©´, ê·¸ê²ƒì— ëŒ€í•´ ë¨¼ì € ê³µê°í•˜ê³  ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”ë¥¼ ì´ì–´ê°€ì„¸ìš”.
ìµœì†Œ 2ë²ˆ ì´ìƒì˜ ëŒ€í™” í„´ì„ í†µí•´ í•™ìƒì— ëŒ€í•´ ì•Œì•„ê°€ì„¸ìš”.
""",

    "í˜„ì‹¤ íƒìƒ‰": """
ë‹¹ì‹ ì€ í•™ìƒë“¤ì˜ ë§ˆìŒì„ ì´í•´í•˜ëŠ” AI ì½”ì¹˜ì…ë‹ˆë‹¤. ì§€ê¸ˆì€ 'í˜„ì‹¤ íƒìƒ‰' ë‹¨ê³„ì…ë‹ˆë‹¤.
ì´ ë‹¨ê³„ì—ì„œëŠ” í•™ìƒì´ ë„ì›€ì´ í•„ìš”í•œ ìƒí™©ì„ êµ¬ì²´ì ìœ¼ë¡œ íƒìƒ‰í•˜ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.

ë‹¤ìŒ ì›ì¹™ì„ ë”°ë¼ì£¼ì„¸ìš”:
1. í˜„ì¬ ì–´ë ¤ì›€ì„ ê²ªê³  ìˆëŠ” ìƒí™©ì— ëŒ€í•´ êµ¬ì²´ì ìœ¼ë¡œ ì§ˆë¬¸í•˜ì„¸ìš”
2. í˜¼ì í•´ê²°í•˜ê¸° ì–´ë ¤ìš´ ë¶€ë¶„ì´ ë¬´ì—‡ì¸ì§€ íƒìƒ‰í•˜ì„¸ìš”
3. ë„ì›€ì„ ë°›ì§€ ëª»í•˜ëŠ” ì´ìœ ë‚˜ ì¥ë²½ì„ íŒŒì•…í•˜ì„¸ìš”
4. í•™êµ ìƒí™œì—ì„œì˜ êµ¬ì²´ì ì¸ ì–´ë ¤ì›€ì— ì£¼ëª©í•˜ì„¸ìš”
5. ê°ì •ê³¼ ìƒê°ì„ êµ¬ë¶„í•´ì„œ íƒìƒ‰í•˜ë„ë¡ ë„ì™€ì£¼ì„¸ìš”

âš ï¸ ë§¤ìš° ì¤‘ìš”í•œ ê·œì¹™ë“¤:
- ë°˜ë“œì‹œ í•œ ë²ˆì— ë‹¨ í•˜ë‚˜ì˜ ì§ˆë¬¸ë§Œ í•˜ì„¸ìš”!
- ì ˆëŒ€ ë‘ ê°œ ì´ìƒì˜ ì§ˆë¬¸ì„ ì—°ì†ìœ¼ë¡œ í•˜ì§€ ë§ˆì„¸ìš”
- "(í•™ìƒì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤)" ê°™ì€ ë©”íƒ€ í‘œí˜„ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
- í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚´ê³ , í•™ìƒì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”
- ì„¤ëª…, ì¡°ì–¸, ì˜ˆì‹œ, í•´ê²°ì±… ì œì‹œëŠ” í•˜ì§€ ë§ˆì„¸ìš”

ì´ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ ì˜ˆì‹œ (í•˜ë‚˜ë§Œ ì„ íƒ):
- ìš”ì¦˜ ê°€ì¥ í˜ë“  ì¼ì€ ë¬´ì—‡ì¸ê°€ìš”?
- ì´ ë¬¸ì œë¥¼ í˜¼ì í•´ê²°í•˜ê¸° ì–´ë ¤ìš´ ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?
- ì´ ìƒí™©ì—ì„œ ì–´ë–¤ ê°ì •ì„ ëŠë¼ë‚˜ìš”?
- ëˆ„êµ°ê°€ì˜ ë„ì›€ì´ ìˆë‹¤ë©´ ì–´ë–¤ ì ì´ ë‹¬ë¼ì§ˆê¹Œìš”?
- ë„ì›€ì„ ìš”ì²­í•˜ê¸° ì–´ë µê²Œ ë§Œë“œëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€ìš”?
- ì´ì „ì— ë¹„ìŠ·í•œ ì–´ë ¤ì›€ì„ ê²ªì€ ì ì´ ìˆë‚˜ìš”?

ìµœì†Œ 3ë²ˆ ì´ìƒì˜ ëŒ€í™” í„´ì„ í†µí•´ í•™ìƒì˜ ìƒí™©ì„ ê¹Šì´ ìˆê²Œ íƒìƒ‰í•˜ì„¸ìš”.
""",

    "ëª©í‘œ ì„¤ì •": """
ë‹¹ì‹ ì€ í•™ìƒë“¤ì˜ ë§ˆìŒì„ ì´í•´í•˜ëŠ” AI ì½”ì¹˜ì…ë‹ˆë‹¤. ì§€ê¸ˆì€ 'ëª©í‘œ ì„¤ì •' ë‹¨ê³„ì…ë‹ˆë‹¤.
ì´ ë‹¨ê³„ì—ì„œëŠ” í•™ìƒì´ ì›í•˜ëŠ” ë³€í™”ì™€ ë„ì›€ë°›ê³  ì‹¶ì€ ë¶€ë¶„ì„ ëª…í™•íˆ í•˜ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.

ë‹¤ìŒ ì›ì¹™ì„ ë”°ë¼ì£¼ì„¸ìš”:
1. í•™ìƒì´ ì›í•˜ëŠ” ë³€í™”ë‚˜ ê²°ê³¼ì— ëŒ€í•´ ì§ˆë¬¸í•˜ì„¸ìš”
2. ì–´ë–¤ ë„ì›€ì„ ë°›ê³  ì‹¶ì€ì§€ êµ¬ì²´ì ìœ¼ë¡œ íƒìƒ‰í•˜ì„¸ìš”
3. ë„ì›€ì„ ë°›ì•˜ì„ ë•Œì˜ ëª¨ìŠµì„ ìƒìƒí•˜ë„ë¡ ë„ì™€ì£¼ì„¸ìš”
4. ì‘ê³  ì‹¤í˜„ ê°€ëŠ¥í•œ ëª©í‘œë¥¼ ì„¸ìš°ë„ë¡ ê²©ë ¤í•˜ì„¸ìš”
5. ëª©í‘œê°€ í•™ìƒì—ê²Œ ì™œ ì¤‘ìš”í•œì§€ í™•ì¸í•˜ì„¸ìš”

âš ï¸ ë§¤ìš° ì¤‘ìš”í•œ ê·œì¹™ë“¤:
- ë°˜ë“œì‹œ í•œ ë²ˆì— ë‹¨ í•˜ë‚˜ì˜ ì§ˆë¬¸ë§Œ í•˜ì„¸ìš”!
- ì ˆëŒ€ ë‘ ê°œ ì´ìƒì˜ ì§ˆë¬¸ì„ ì—°ì†ìœ¼ë¡œ í•˜ì§€ ë§ˆì„¸ìš”
- "(í•™ìƒì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤)" ê°™ì€ ë©”íƒ€ í‘œí˜„ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
- í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚´ê³ , í•™ìƒì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”
- ì„¤ëª…, ì¡°ì–¸, ì˜ˆì‹œ, í•´ê²°ì±… ì œì‹œëŠ” í•˜ì§€ ë§ˆì„¸ìš”

ì´ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ ì˜ˆì‹œ (í•˜ë‚˜ë§Œ ì„ íƒ):
- ì´ ìƒí™©ì—ì„œ ì–´ë–¤ ë³€í™”ë¥¼ ì›í•˜ë‚˜ìš”?
- ì–´ë–¤ ë„ì›€ì„ ë°›ìœ¼ë©´ ì¢‹ì„ê¹Œìš”?
- ë¬¸ì œê°€ í•´ê²°ëœë‹¤ë©´ ì–´ë–¤ ëª¨ìŠµì¼ê¹Œìš”?
- ê°€ì¥ ë¨¼ì € ë°”ë€Œì—ˆìœ¼ë©´ í•˜ëŠ” ê²ƒì€ ë¬´ì—‡ì¸ê°€ìš”?
- ì´ ëª©í‘œê°€ ì™œ ì¤‘ìš”í•œê°€ìš”?
- ì‘ì€ ë³€í™”ë¼ë„ ê´œì°®ì€ë°, ë¬´ì—‡ë¶€í„° ì‹œì‘í•˜ê³  ì‹¶ë‚˜ìš”?

ìµœì†Œ 2ë²ˆ ì´ìƒì˜ ëŒ€í™” í„´ì„ í†µí•´ í•™ìƒì˜ ëª©í‘œë¥¼ ëª…í™•í•˜ê²Œ ì„¤ì •í•˜ë„ë¡ ë„ì™€ì£¼ì„¸ìš”.
""",

    "ëŒ€ì•ˆ íƒìƒ‰": """
ë‹¹ì‹ ì€ í•™ìƒë“¤ì˜ ë§ˆìŒì„ ì´í•´í•˜ëŠ” AI ì½”ì¹˜ì…ë‹ˆë‹¤. ì§€ê¸ˆì€ 'ëŒ€ì•ˆ íƒìƒ‰' ë‹¨ê³„ì…ë‹ˆë‹¤.
ì´ ë‹¨ê³„ì—ì„œëŠ” í•™ìƒì´ ë„ì›€ì„ ë°›ì„ ìˆ˜ ìˆëŠ” ë‹¤ì–‘í•œ ë°©ë²•ê³¼ ì‚¬ëŒë“¤ì„ íƒìƒ‰í•˜ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.

ë‹¤ìŒ ì›ì¹™ì„ ë”°ë¼ì£¼ì„¸ìš”:
1. ë„ì›€ì„ ë°›ì„ ìˆ˜ ìˆëŠ” ë‹¤ì–‘í•œ ì‚¬ëŒë“¤ì„ ë– ì˜¬ë¦¬ë„ë¡ ì§ˆë¬¸í•˜ì„¸ìš”
2. ê°ê°ì˜ ì‚¬ëŒì—ê²Œ ì–´ë–»ê²Œ ë„ì›€ì„ ìš”ì²­í• ì§€ íƒìƒ‰í•˜ì„¸ìš”
3. ë„ì›€ ìš”ì²­ì˜ ë‹¤ì–‘í•œ ë°©ë²•(ì§ì ‘, ë©”ì‹œì§€, í¸ì§€ ë“±)ì„ ê³ ë ¤í•˜ë„ë¡ í•˜ì„¸ìš”
4. ê³¼ê±°ì— ë„ì›€ì„ ë°›ì•˜ë˜ ê¸ì •ì  ê²½í—˜ì„ í™œìš©í•˜ì„¸ìš”
5. ë„ì›€ ìš”ì²­ì´ ì–´ë µê²Œ ëŠê»´ì§€ëŠ” ì´ìœ ë¥¼ ì´í•´í•˜ê³  ëŒ€ì•ˆì„ ì°¾ì•„ë³´ì„¸ìš”

âš ï¸ ë§¤ìš° ì¤‘ìš”í•œ ê·œì¹™ë“¤:
- ë°˜ë“œì‹œ í•œ ë²ˆì— ë‹¨ í•˜ë‚˜ì˜ ì§ˆë¬¸ë§Œ í•˜ì„¸ìš”!
- ì ˆëŒ€ ë‘ ê°œ ì´ìƒì˜ ì§ˆë¬¸ì„ ì—°ì†ìœ¼ë¡œ í•˜ì§€ ë§ˆì„¸ìš”
- "(í•™ìƒì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤)" ê°™ì€ ë©”íƒ€ í‘œí˜„ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
- í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚´ê³ , í•™ìƒì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”
- ì„¤ëª…, ì¡°ì–¸, ì˜ˆì‹œ, í•´ê²°ì±… ì œì‹œëŠ” í•˜ì§€ ë§ˆì„¸ìš”

ì´ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ ì˜ˆì‹œ (í•˜ë‚˜ë§Œ ì„ íƒ):
- ì£¼ë³€ì— ë„ì›€ì„ ì¤„ ìˆ˜ ìˆëŠ” ì‚¬ëŒì€ ëˆ„ê°€ ìˆì„ê¹Œìš”?
- ê·¸ ì‚¬ëŒì—ê²Œ ì–´ë–»ê²Œ ë§í•˜ë©´ ì¢‹ì„ê¹Œìš”?
- ì§ì ‘ ë§í•˜ê¸° ì–´ë µë‹¤ë©´ ì–´ë–¤ ë°©ë²•ì´ ìˆì„ê¹Œìš”?
- ì˜ˆì „ì— ë„ì›€ì„ ë°›ì•˜ë˜ ì¢‹ì€ ê²½í—˜ì´ ìˆë‚˜ìš”?
- ì¹œêµ¬ê°€ ê°™ì€ ìƒí™©ì´ë¼ë©´ ëˆ„êµ¬ì—ê²Œ ë„ì›€ì„ êµ¬í•˜ë¼ê³  í• ê¹Œìš”?
- ì‘ì€ ë„ì›€ì´ë¼ë„ ë°›ì„ ìˆ˜ ìˆëŠ” ë°©ë²•ì€ ë¬´ì—‡ì¼ê¹Œìš”?

ìµœì†Œ 3ë²ˆ ì´ìƒì˜ ëŒ€í™” í„´ì„ í†µí•´ í•™ìƒì´ ë‹¤ì–‘í•œ ë„ì›€ ìš”ì²­ ë°©ë²•ì„ íƒìƒ‰í•˜ë„ë¡ ë„ì™€ì£¼ì„¸ìš”.
""",

    "ì‹¤í–‰ ê³„íš": """
ë‹¹ì‹ ì€ í•™ìƒë“¤ì˜ ë§ˆìŒì„ ì´í•´í•˜ëŠ” AI ì½”ì¹˜ì…ë‹ˆë‹¤. ì§€ê¸ˆì€ 'ì‹¤í–‰ ê³„íš' ë‹¨ê³„ì…ë‹ˆë‹¤.
ì´ ë‹¨ê³„ì—ì„œëŠ” í•™ìƒì´ ì‹¤ì œë¡œ ë„ì›€ì„ ìš”ì²­í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ê³„íšì„ ì„¸ìš°ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.

ë‹¤ìŒ ì›ì¹™ì„ ë”°ë¼ì£¼ì„¸ìš”:
1. êµ¬ì²´ì ì¸ ë„ì›€ ìš”ì²­ ê³„íšì„ ì„¸ìš°ë„ë¡ ì§ˆë¬¸í•˜ì„¸ìš”
2. ì–¸ì œ, ì–´ë””ì„œ, ì–´ë–»ê²Œ ë„ì›€ì„ ìš”ì²­í• ì§€ êµ¬ì²´í™”í•˜ì„¸ìš”
3. ë„ì›€ ìš”ì²­í•  ë•Œ ì‚¬ìš©í•  ë§ì„ ì—°ìŠµí•˜ë„ë¡ ë„ì™€ì£¼ì„¸ìš”
4. ì˜ˆìƒë˜ëŠ” ì–´ë ¤ì›€ê³¼ ëŒ€ì²˜ ë°©ë²•ì„ ì¤€ë¹„í•˜ì„¸ìš”
5. ì‘ì€ ì²«ê±¸ìŒë¶€í„° ì‹œì‘í•˜ë„ë¡ ê²©ë ¤í•˜ì„¸ìš”

âš ï¸ ë§¤ìš° ì¤‘ìš”í•œ ê·œì¹™ë“¤:
- ë°˜ë“œì‹œ í•œ ë²ˆì— ë‹¨ í•˜ë‚˜ì˜ ì§ˆë¬¸ë§Œ í•˜ì„¸ìš”!
- ì ˆëŒ€ ë‘ ê°œ ì´ìƒì˜ ì§ˆë¬¸ì„ ì—°ì†ìœ¼ë¡œ í•˜ì§€ ë§ˆì„¸ìš”
- "(í•™ìƒì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤)" ê°™ì€ ë©”íƒ€ í‘œí˜„ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
- í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚´ê³ , í•™ìƒì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”
- ì„¤ëª…, ì¡°ì–¸, ì˜ˆì‹œ, í•´ê²°ì±… ì œì‹œëŠ” í•˜ì§€ ë§ˆì„¸ìš”

ì´ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ ì˜ˆì‹œ (í•˜ë‚˜ë§Œ ì„ íƒ):
- ëˆ„êµ¬ì—ê²Œ ë¨¼ì € ë„ì›€ì„ ìš”ì²­í•´ë³¼ê¹Œìš”?
- ì–¸ì œ ê·¸ ì‚¬ëŒê³¼ ì´ì•¼ê¸°í•˜ë©´ ì¢‹ì„ê¹Œìš”?
- ì²« ë§ˆë””ë¥¼ ì–´ë–»ê²Œ ì‹œì‘í•˜ë©´ ì¢‹ì„ê¹Œìš”?
- ë§Œì•½ ê±°ì ˆë‹¹í•œë‹¤ë©´ ì–´ë–»ê²Œ í• ê¹Œìš”?
- ì˜¤ëŠ˜ ë‹¹ì¥ í•  ìˆ˜ ìˆëŠ” ì‘ì€ í–‰ë™ì€ ë¬´ì—‡ì¼ê¹Œìš”?
- ìš©ê¸°ë¥¼ ë‚´ëŠ” ë° ë„ì›€ì´ ë˜ëŠ” ê²ƒì€ ë¬´ì—‡ì¼ê¹Œìš”?

ìµœì†Œ 2ë²ˆ ì´ìƒì˜ ëŒ€í™” í„´ì„ í†µí•´ í•™ìƒì´ ì‹¤í–‰ ê°€ëŠ¥í•œ ê³„íšì„ ì„¸ìš°ë„ë¡ ë„ì™€ì£¼ì„¸ìš”.
""",

    "ì •ë¦¬ ë° ë§ˆë¬´ë¦¬": """
ë‹¹ì‹ ì€ í•™ìƒë“¤ì˜ ë§ˆìŒì„ ì´í•´í•˜ëŠ” AI ì½”ì¹˜ì…ë‹ˆë‹¤. ì§€ê¸ˆì€ 'ì •ë¦¬ ë° ë§ˆë¬´ë¦¬' ë‹¨ê³„ì…ë‹ˆë‹¤.
ì´ ë‹¨ê³„ì—ì„œëŠ” ì˜¤ëŠ˜ ëŒ€í™”ë¥¼ ì •ë¦¬í•˜ê³  í•™ìƒì˜ ìš©ê¸°ì™€ ì„±ì¥ì„ ê²©ë ¤í•˜ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.

ë‹¤ìŒ ì›ì¹™ì„ ë”°ë¼ì£¼ì„¸ìš”:
1. ì˜¤ëŠ˜ ëŒ€í™”ì—ì„œ ì–»ì€ í†µì°°ê³¼ ë°°ì›€ì„ ì •ë¦¬í•˜ë„ë¡ ì§ˆë¬¸í•˜ì„¸ìš”
2. ë„ì›€ ìš”ì²­ì— ëŒ€í•œ ìƒê°ì´ ì–´ë–»ê²Œ ë³€í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”
3. í•™ìƒì˜ ìš©ê¸°ì™€ ë…¸ë ¥ì„ ì¸ì •í•˜ê³  ê²©ë ¤í•˜ì„¸ìš”
4. ì¹œêµ¬ë“¤ê³¼ ë‚˜ëˆŒ ìˆ˜ ìˆëŠ” ë‚´ìš©ì„ ì¤€ë¹„í•˜ë„ë¡ ë„ì™€ì£¼ì„¸ìš”
5. ì‹¤ì²œ ì˜ì§€ë¥¼ í™•ì¸í•˜ê³  ì‘ì›í•˜ì„¸ìš”

âš ï¸ ë§¤ìš° ì¤‘ìš”í•œ ê·œì¹™ë“¤:
- ë°˜ë“œì‹œ í•œ ë²ˆì— ë‹¨ í•˜ë‚˜ì˜ ì§ˆë¬¸ë§Œ í•˜ì„¸ìš”!
- ì ˆëŒ€ ë‘ ê°œ ì´ìƒì˜ ì§ˆë¬¸ì„ ì—°ì†ìœ¼ë¡œ í•˜ì§€ ë§ˆì„¸ìš”
- "(í•™ìƒì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤)" ê°™ì€ ë©”íƒ€ í‘œí˜„ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
- í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚´ê³ , í•™ìƒì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”
- ì„¤ëª…, ì¡°ì–¸, ì˜ˆì‹œ, í•´ê²°ì±… ì œì‹œëŠ” í•˜ì§€ ë§ˆì„¸ìš”

ì´ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ ì˜ˆì‹œ (í•˜ë‚˜ë§Œ ì„ íƒ):
- ì˜¤ëŠ˜ ëŒ€í™”ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê¹¨ë‹¬ìŒì€ ë¬´ì—‡ì¸ê°€ìš”?
- ì¹œêµ¬ë“¤ê³¼ ë‚˜ëˆ„ê³  ì‹¶ì€ ì´ì•¼ê¸°ê°€ ìˆë‹¤ë©´ ë¬´ì—‡ì¸ê°€ìš”?
- ë„ì›€ ìš”ì²­ì— ëŒ€í•œ ìƒê°ì´ ì–´ë–»ê²Œ ë°”ë€Œì—ˆë‚˜ìš”?
- ì‹¤ì œë¡œ ë„ì›€ì„ ìš”ì²­í•œë‹¤ë©´ ì–´ë–¤ ë§ˆìŒì¼ê¹Œìš”?
- ì˜¤ëŠ˜ ëŒ€í™”ë¥¼ í†µí•´ ì–´ë–¤ ìš©ê¸°ë¥¼ ì–»ì—ˆë‚˜ìš”?
- ìì‹ ì—ê²Œ í•´ì£¼ê³  ì‹¶ì€ ì‘ì›ì˜ ë§ì€ ë¬´ì—‡ì¸ê°€ìš”?

ìµœì†Œ 2ë²ˆ ì´ìƒì˜ ëŒ€í™” í„´ì„ í†µí•´ í•™ìƒì´ ì˜¤ëŠ˜ ì„¸ì…˜ì„ ì˜ë¯¸ìˆê²Œ ë§ˆë¬´ë¦¬í•˜ë„ë¡ ë„ì™€ì£¼ì„¸ìš”.
ë§ˆì§€ë§‰ì—ëŠ” ë”°ëœ»í•œ ê²©ë ¤ì™€ ì‘ì›ì˜ ë©”ì‹œì§€ë¥¼ ì „í•´ì£¼ì„¸ìš”.
"""
}

# ì„¸ì…˜ ë§Œë£Œ ì‹œê°„ ì„¤ì • (24ì‹œê°„)
SESSION_TIMEOUT_HOURS = 24
RESUME_CHECK_HOURS = 1  # 1ì‹œê°„ ì´í›„ ì¬ê°œ í™•ì¸
SESSION_TIME_LIMIT_MINUTES = 18  # ìˆ˜ì—… ì‹œê°„ ê³ ë ¤í•œ ì œí•œ ì‹œê°„

class SessionManager:
    """ì‚¬ìš©ì ì„¸ì…˜ì„ ê´€ë¦¬í•˜ëŠ” í´ë˜ìŠ¤."""
    def __init__(self):
        self.cache = {}

    def is_session_expired(self, session_data: dict) -> bool:
        """ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤."""
        try:
            last_active = datetime.fromisoformat(session_data.get('last_active', ''))
            timeout = datetime.utcnow() - timedelta(hours=SESSION_TIMEOUT_HOURS)
            return last_active < timeout
        except (ValueError, TypeError):
            return True

    def needs_resume_check(self, session_data: dict) -> bool:
        """ì„¸ì…˜ ì¬ê°œ í™•ì¸ì´ í•„ìš”í•œì§€ í™•ì¸í•©ë‹ˆë‹¤."""
        try:
            last_active = datetime.fromisoformat(session_data.get('last_active', ''))
            resume_threshold = datetime.utcnow() - timedelta(hours=RESUME_CHECK_HOURS)
            return last_active < resume_threshold
        except (ValueError, TypeError):
            return False

    def get_session_duration(self, session_data: dict) -> int:
        """ì„¸ì…˜ ì§„í–‰ ì‹œê°„ì„ ë¶„ ë‹¨ìœ„ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤."""
        try:
            start_time = datetime.fromisoformat(session_data.get('session_start_time', ''))
            duration = (datetime.utcnow() - start_time).total_seconds() / 60
            return int(duration)
        except:
            return 0

    def get_session(self, user_id: str) -> dict:
        """DynamoDBì—ì„œ ì„¸ì…˜ì„ ì¡°íšŒí•˜ê±°ë‚˜ ê¸°ë³¸ ì„¸ì…˜ì„ ìƒì„±í•œë‹¤."""
        try:
            session = sessions_table.get_item(Key={'user_id': user_id})
            session_data = session.get('Item', None)
            
            # ì„¸ì…˜ì´ ì—†ê±°ë‚˜ ë§Œë£Œëœ ê²½ìš° ìƒˆ ì„¸ì…˜ ìƒì„±
            if session_data is None or self.is_session_expired(session_data):
                session_data = self.create_new_session(user_id)
                self.update_session(session_data)
                
            return session_data
        except Exception as e:
            logger.exception("Error getting session", exc_info=e)
            return self.create_new_session(user_id)

    def get_previous_sessions(self, user_id: str, limit: int = 5) -> list:
        """ì‚¬ìš©ìì˜ ì´ì „ ì™„ë£Œëœ ì„¸ì…˜ë“¤ì„ ì¡°íšŒí•©ë‹ˆë‹¤."""
        try:
            response = completed_sessions_table.query(
                KeyConditionExpression=Key('user_id').eq(user_id),
                ScanIndexForward=False,  # ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
                Limit=limit
            )
            return response.get('Items', [])
        except Exception as e:
            logger.error(f"Error getting previous sessions: {str(e)}")
            return []

    def save_completed_session(self, session_data: dict) -> None:
        """ì™„ë£Œëœ ì„¸ì…˜ì„ ì €ì¥í•©ë‹ˆë‹¤."""
        try:
            # ì„¸ì…˜ ìš”ì•½ ì •ë³´ ì¶”ì¶œ
            summary = self.extract_session_summary(session_data)
            
            completed_session = {
                'user_id': session_data['user_id'],
                'session_id': f"{session_data['user_id']}_{session_data['session_start_time']}",
                'session_start_time': session_data['session_start_time'],
                'session_end_time': datetime.utcnow().isoformat(),
                'summary': summary,
                'conversation_history': session_data.get('conversation_history', []),
                'crisis_detected': session_data.get('crisis_detected', False)
            }
            
            completed_sessions_table.put_item(Item=completed_session)
            logger.info("Completed session saved successfully")
        except Exception as e:
            logger.error(f"Error saving completed session: {str(e)}")

    def extract_session_summary(self, session_data: dict) -> dict:
        """ë„ì›€ìš”ì²­ ì£¼ì œì— ë§ì¶˜ ì„¸ì…˜ ìš”ì•½ì„ ì¶”ì¶œí•©ë‹ˆë‹¤."""
        conversation_history = session_data.get('conversation_history', [])
        
        summary = {
            'difficulties': [],      # ì–´ë ¤ì›€
            'help_needs': [],       # ë„ì›€ í•„ìš” ì˜ì—­
            'barriers': [],         # ë„ì›€ìš”ì²­ ì¥ë²½
            'helpers': [],          # ë„ì›€ì¤„ ìˆ˜ ìˆëŠ” ì‚¬ëŒ
            'action_plans': [],     # ì‹¤ì²œ ê³„íš
            'insights': [],         # í†µì°°
            'last_stage': COACHING_STAGES[int(session_data.get('current_stage', 0))]
        }
        
        # ëŒ€í™” ë‚´ìš©ì—ì„œ ì£¼ìš” ì •ë³´ ì¶”ì¶œ
        for msg in conversation_history:
            if msg.get('role') == 'user':
                content = msg.get('content', '').lower()
                
                # ì–´ë ¤ì›€ ê´€ë ¨ í‚¤ì›Œë“œ
                if any(keyword in content for keyword in ['í˜ë“¤', 'ì–´ë ¤', 'ëª»í•˜', 'ì•ˆë˜', 'ê±±ì •']):
                    summary['difficulties'].append(content[:50])
                
                # ë„ì›€ í•„ìš” ê´€ë ¨
                if any(keyword in content for keyword in ['ë„ì›€', 'í•„ìš”', 'í˜¼ì', 'ê°™ì´']):
                    summary['help_needs'].append(content[:50])
                
                # ë„ì›€ìš”ì²­ ì¥ë²½
                if any(keyword in content for keyword in ['ë¶€ë„ëŸ¬', 'ë¯¼í', 'ì‹«ì–´', 'ê±°ì ˆ', 'ë¬´ì„œ']):
                    summary['barriers'].append(content[:50])
                
                # ë„ì›€ì¤„ ìˆ˜ ìˆëŠ” ì‚¬ëŒ
                if any(keyword in content for keyword in ['ì„ ìƒë‹˜', 'ë¶€ëª¨ë‹˜', 'ì¹œêµ¬', 'ìƒë‹´', 'ì–¸ë‹ˆ', 'ì˜¤ë¹ ', 'ëˆ„ë‚˜', 'í˜•']):
                    summary['helpers'].append(content[:50])
                
                # ì‹¤ì²œ ê³„íš
                if any(keyword in content for keyword in ['í• ê²Œ', 'í•˜ê² ', 'í•´ë³¼ê²Œ', 'ì‹œë„']):
                    summary['action_plans'].append(content[:50])
        
        # ê° ì¹´í…Œê³ ë¦¬ë³„ë¡œ ìµœëŒ€ 3ê°œë§Œ ì €ì¥
        for key in summary:
            if isinstance(summary[key], list):
                summary[key] = summary[key][-3:]
        
        return summary

    def create_new_session(self, user_id: str) -> dict:
        """ìƒˆ ì„¸ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤."""
        return {
            'user_id': user_id,
            'current_stage': 0,
            'stage_question_count': 0,
            'conversation_history': [],
            'session_start_time': datetime.utcnow().isoformat(),
            'last_active': datetime.utcnow().isoformat(),
            'awaiting_resume_response': False,
            'crisis_detected': False
        }

    def reset_session(self, user_id: str) -> dict:
        """ì„¸ì…˜ì„ ë¦¬ì…‹í•˜ê³  ìƒˆ ì„¸ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤."""
        # í˜„ì¬ ì„¸ì…˜ì„ ì™„ë£Œëœ ì„¸ì…˜ìœ¼ë¡œ ì €ì¥
        current_session = self.get_session(user_id)
        if current_session and len(current_session.get('conversation_history', [])) > 0:
            self.save_completed_session(current_session)
        
        session_data = self.create_new_session(user_id)
        self.update_session(session_data)
        return session_data

    def update_session(self, session_data: dict) -> None:
        """DynamoDBì— ì„¸ì…˜ ì •ë³´ë¥¼ ì €ì¥í•œë‹¤."""
        try:
            # current_stageì™€ stage_question_countë¥¼ intë¡œ ë³´ì¥
            session_data['current_stage'] = int(session_data.get('current_stage', 0))
            session_data['stage_question_count'] = int(session_data.get('stage_question_count', 0))
            session_data['last_active'] = datetime.utcnow().isoformat()
            
            sessions_table.put_item(Item=session_data)
            logger.info("Session updated successfully")
        except Exception as e:
            logger.exception("Error updating session", exc_info=e)

def get_previous_context(user_id: str, session_manager: SessionManager) -> str:
    """ì´ì „ ì„¸ì…˜ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    previous_sessions = session_manager.get_previous_sessions(user_id, limit=3)
    
    if not previous_sessions:
        return ""
    
    context_parts = []
    
    # ê°€ì¥ ìµœê·¼ ì„¸ì…˜ ì •ë³´
    if previous_sessions:
        latest_session = previous_sessions[0]
        summary = latest_session.get('summary', {})
        
        if summary.get('difficulties'):
            context_parts.append(f"ì´ì „ì— ì´ì•¼ê¸°í–ˆë˜ ì–´ë ¤ì›€: {', '.join(summary['difficulties'])}")
        
        if summary.get('action_plans'):
            context_parts.append(f"ì§€ë‚œë²ˆì— ê³„íší–ˆë˜ ê²ƒ: {', '.join(summary['action_plans'])}")
        
        if summary.get('helpers'):
            context_parts.append(f"ë„ì›€ë°›ì„ ìˆ˜ ìˆë‹¤ê³  í–ˆë˜ ì‚¬ëŒ: {', '.join(summary['helpers'])}")
    
    if context_parts:
        return f"\n[ì´ì „ ëŒ€í™” ì°¸ê³ ]\n" + "\n".join(context_parts) + "\nìì—°ìŠ¤ëŸ½ê²Œ ì´ì „ ëŒ€í™” ë‚´ìš©ì„ ì–¸ê¸‰í•˜ë©° ì‹œì‘í•˜ì„¸ìš”.\n"
    
    return ""

def get_conversation_summary(conversation_history: list) -> str:
    """ëŒ€í™” ë‚´ìš©ì„ ìš”ì•½í•©ë‹ˆë‹¤."""
    if len(conversation_history) < 2:
        return "ë°©ê¸ˆ ëŒ€í™”ë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤"
    
    # ìµœê·¼ 5ê°œ ë©”ì‹œì§€ì—ì„œ ì£¼ìš” ë‚´ìš© ì¶”ì¶œ
    recent_messages = conversation_history[-5:]
    topics = []
    
    for msg in recent_messages:
        if msg.get('role') == 'user':
            content = msg.get('content', '')[:100]  # 100ìê¹Œì§€ë§Œ
            if content:
                topics.append(content)
    
    if topics:
        return f"{', '.join(topics[:2])}"  # ìµœëŒ€ 2ê°œ í† í”½ë§Œ í‘œì‹œ
    
    return "ì´ì „ ëŒ€í™” ë‚´ìš©"

def check_reset_keywords(message: str) -> bool:
    """ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ë¦¬ì…‹ í‚¤ì›Œë“œë¥¼ í¬í•¨í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤."""
    message_lower = message.lower().strip()
    for pattern in RESET_PATTERNS:
        if re.search(pattern, message_lower):
            return True
    return False

def check_end_keywords(message: str) -> bool:
    """ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ì¢…ë£Œ í‚¤ì›Œë“œë¥¼ í¬í•¨í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤."""
    message_lower = message.lower().strip()
    for pattern in END_PATTERNS:
        if re.search(pattern, message_lower):
            return True
    return False

def check_continue_keywords(message: str) -> bool:
    """ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ê³„ì†í•˜ê¸° í‚¤ì›Œë“œë¥¼ í¬í•¨í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤."""
    message_lower = message.lower().strip()
    for pattern in CONTINUE_PATTERNS:
        if re.search(pattern, message_lower):
            return True
    return False

def check_new_session_keywords(message: str) -> bool:
    """ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ìƒˆ ì„¸ì…˜ í‚¤ì›Œë“œë¥¼ í¬í•¨í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤."""
    message_lower = message.lower().strip()
    for pattern in NEW_SESSION_PATTERNS:
        if re.search(pattern, message_lower):
            return True
    return False

def check_crisis_keywords(message: str) -> bool:
    """ìœ„ê¸° ìƒí™© í‚¤ì›Œë“œë¥¼ í™•ì¸í•©ë‹ˆë‹¤."""
    message_lower = message.lower()
    for pattern in CRISIS_PATTERNS:
        if re.search(pattern, message_lower):
            return True
    return False

def call_upstage_solar_api(messages, system_prompt=None):
    """Upstage Solar Pro2 APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤."""
    api_url = "https://api.upstage.ai/v1/chat/completions"
    api_key = os.environ.get("UPSTAGE_API_KEY")
    
    if not api_key:
        logger.error("UPSTAGE_API_KEY environment variable not set")
        return None
    
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Content-Type": "application/json"
    }
    
    # ìµœê·¼ ëŒ€í™”ë§Œ í¬í•¨ (ì»¨í…ìŠ¤íŠ¸ ì œí•œ)
    recent_messages = messages[-6:] if len(messages) > 6 else messages
    
    # ë©”ì‹œì§€ í˜•ì‹ ë³€í™˜
    formatted_messages = []
    
    # ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì¶”ê°€ (ë©”íƒ€ í‘œí˜„ ê¸ˆì§€ ê°•í™”)
    if system_prompt:
        enhanced_prompt = f"""
{system_prompt}

ğŸš« ì ˆëŒ€ ê¸ˆì§€ì‚¬í•­:
1. í•œ ë²ˆì— ë°˜ë“œì‹œ ë”± í•˜ë‚˜ì˜ ì§ˆë¬¸ë§Œ ì¶œë ¥í•˜ê³  ì¦‰ì‹œ ì¢…ë£Œ
2. í•™ìƒì˜ ì´ì „ ë‹µë³€ì„ ë‹¤ì‹œ ë¬»ê±°ë‚˜ êµ¬ì²´í™” ìš”ì²­ ê¸ˆì§€
3. "(í•™ìƒì˜ ë‹µë³€ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤)" ê°™ì€ ê´„í˜¸ í‘œí˜„ ì ˆëŒ€ ê¸ˆì§€
4. ì´ëª¨ì§€ëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
5. ë‹¨ê³„ì˜ ëª©í‘œì— ë§ëŠ” ìƒˆë¡œìš´ ê´€ì ì˜ ì§ˆë¬¸ì„ í•˜ì„¸ìš”

ì¶œë ¥ ì˜ˆì‹œ:
ì¢‹ì€ ì˜ˆ: "ìš”ì¦˜ ê°€ì¥ í˜ë“  ì¼ì€ ë¬´ì—‡ì¸ê°€ìš”?"
ë‚˜ìœ ì˜ˆ: "ê·¸ ë¶€ë¶„ì— ëŒ€í•´ ì¢€ ë” ìì„¸íˆ ë§í•´ì£¼ì‹¤ë˜ìš”?"
ë‚˜ìœ ì˜ˆ: "ì•„ê¹Œ ë§ì”€í•˜ì‹  ê·¸ ë¬¸ì œê°€ êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ê±´ê°€ìš”?"

í•œ ê°œì˜ ìƒˆë¡œìš´ ì§ˆë¬¸ë§Œ ì¶œë ¥í•˜ê³  ì¢…ë£Œí•˜ì„¸ìš”."""
        formatted_messages.append({"role": "system", "content": enhanced_prompt})
    
    # ëŒ€í™” íˆìŠ¤í† ë¦¬ ì¶”ê°€ (ìµœê·¼ ê²ƒë§Œ)
    for m in recent_messages:
        if isinstance(m, dict) and "role" in m and "content" in m:
            formatted_messages.append({"role": m["role"], "content": m["content"]})
    
    payload = {
        "model": "solar-pro2",
        "messages": formatted_messages,
        "max_tokens": 150,  # í† í° ì œí•œ
        "temperature": 0.8,  # ë‹¤ì–‘ì„± ì¦ê°€
        "stream": False
    }
    
    try:
        encoded = json.dumps(payload).encode("utf-8")
        response = http.request(
            "POST",
            api_url,
            body=encoded,
            headers=headers,
            timeout=30.0
        )
        
        if response.status != 200:
            logger.error(f"Upstage API returned status {response.status}: {response.data.decode('utf-8')}")
            return None
        
        result = json.loads(response.data.decode("utf-8"))
        
        # ì‘ë‹µ ì¶”ì¶œ ë° ì •ì œ
        if "choices" in result and len(result["choices"]) > 0:
            response_text = result["choices"][0]["message"]["content"]
            
            # ì²« ë²ˆì§¸ ì§ˆë¬¸ë§Œ ì¶”ì¶œ (ë¬¼ìŒí‘œ ê¸°ì¤€)
            if '?' in response_text:
                # ì²« ë²ˆì§¸ ë¬¼ìŒí‘œê¹Œì§€ë§Œ ìë¥´ê¸°
                first_question = response_text.split('?')[0] + '?'
                response_text = first_question
            
            # ë©”íƒ€ í‘œí˜„ ì œê±°
            response_text = re.sub(r'\([^)]*\)', '', response_text)  # ëª¨ë“  ê´„í˜¸ ë‚´ìš© ì œê±°
            response_text = re.sub(r'\*[^*]*\*', '', response_text)  # * í‘œí˜„ ì œê±°
            
            # ì´ëª¨ì§€ ì œê±°
            response_text = re.sub(r'[ğŸ˜ŠğŸ’ªğŸ‰ğŸ’™â°ğŸš«âš ï¸]+', '', response_text)
            
            # ì—¬ëŸ¬ ì¤„ì¸ ê²½ìš° ì²« ì¤„ë§Œ
            lines = response_text.strip().split('\n')
            if lines:
                response_text = lines[0].strip()
            
            return response_text
        else:
            logger.error(f"Unexpected response format from Upstage API: {result}")
            return None
        
    except Exception as e:
        logger.error(f"Error calling Upstage Solar API: {str(e)}")
        return None

def should_advance_stage(session_data: dict, user_message: str) -> bool:
    """ë‹¨ê³„ë¥¼ ì „í™˜í•´ì•¼ í•˜ëŠ”ì§€ íŒë‹¨í•©ë‹ˆë‹¤."""
    stage_question_count = int(session_data.get('stage_question_count', 0))
    current_stage = int(session_data.get('current_stage', 0))
    conversation_history = session_data.get('conversation_history', [])
    
    # ìˆ˜ì—… ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ ë‹¨ê³„ë³„ ìµœì†Œ/ìµœëŒ€ ì§ˆë¬¸ ìˆ˜ ì„¤ì •
    stage_name = COACHING_STAGES[current_stage]
    
    # ë‹¨ê³„ë³„ ì§ˆë¬¸ ìˆ˜ ê¸°ì¤€
    stage_limits = {
        "ì‹ ë¢° í˜•ì„±": {"min": 2, "max": 3},
        "í˜„ì‹¤ íƒìƒ‰": {"min": 3, "max": 4},
        "ëª©í‘œ ì„¤ì •": {"min": 2, "max": 3},
        "ëŒ€ì•ˆ íƒìƒ‰": {"min": 3, "max": 4},
        "ì‹¤í–‰ ê³„íš": {"min": 2, "max": 3},
        "ì •ë¦¬ ë° ë§ˆë¬´ë¦¬": {"min": 2, "max": 3}
    }
    
    limits = stage_limits.get(stage_name, {"min": 2, "max": 3})
    
    # ìµœëŒ€ ì§ˆë¬¸ ìˆ˜ë¥¼ ë„˜ìœ¼ë©´ ë¬´ì¡°ê±´ ì „í™˜
    if stage_question_count >= limits["max"]:
        logger.info(f"Stage {stage_name}: max questions ({limits['max']}) reached, advancing")
        return True
    
    # ìµœì†Œ ì§ˆë¬¸ ìˆ˜ë¥¼ ì¶©ì¡±í•˜ì§€ ëª»í•˜ë©´ ê³„ì†
    if stage_question_count < limits["min"]:
        return False
    
    # ìµœì†Œ ì§ˆë¬¸ ìˆ˜ ì¶©ì¡± í›„, í•™ìƒ ë‹µë³€ì˜ ì¶©ì‹¤ë„ ì²´í¬
    user_message_length = len(user_message.strip())
    
    # ì§§ì€ ë‹µë³€(20ì ë¯¸ë§Œ)ì´ ì—°ì†ìœ¼ë¡œ ë‚˜ì˜¤ë©´ ë‹¨ê³„ ì „í™˜
    if user_message_length < 20:
        recent_user_messages = [msg['content'] for msg in conversation_history[-4:] if msg['role'] == 'user']
        short_answers = sum(1 for msg in recent_user_messages if len(msg) < 20)
        if short_answers >= 2:
            logger.info(f"Stage {stage_name}: short answers detected, advancing")
            return True
    
    # ì¶©ì‹¤í•œ ë‹µë³€ì´ ë‚˜ì™”ìœ¼ë©´ ì „í™˜
    if user_message_length > 50:
        logger.info(f"Stage {stage_name}: detailed answer received, advancing")
        return True
    
    # ìµœì¢… ë‹¨ê³„ì¸ì§€ í™•ì¸
    if current_stage >= len(COACHING_STAGES) - 1:
        return False
    
    return False

def lambda_handler(event, context):
    """AWS Lambda ì§„ì…ì : ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ê³  ì ì ˆí•œ ì‘ë‹µì„ ë°˜í™˜."""
    try:
        logger.info("event íƒ€ì…: %s, event: %s", type(event), event)
        body = event.get('body', '{}')
        if isinstance(body, str):
            logger.info("raw body: %s", body)
            try:
                body = json.loads(body)
            except json.JSONDecodeError as e:
                logger.error("body ë¬¸ìì—´ì„ jsonìœ¼ë¡œ ë³€í™˜ ì‹¤íŒ¨: %s", str(e))
                body = {}
        if not isinstance(body, dict):
            logger.error("bodyê°€ dictê°€ ì•„ë‹˜: %s", type(body))
            body = {}
        logger.info("body after parsing: %s", body)

        user_request = body.get('userRequest', {})
        if not isinstance(user_request, dict):
            logger.error("userRequestê°€ dictê°€ ì•„ë‹˜: %s", type(user_request))
            user_request = {}
        logger.info("userRequest after parsing: %s", user_request)

        user_id = user_request.get('user', {}).get('id', 'unknown')
        user_message = user_request.get('utterance', '')
        logger.info("user_id: %s, user_message: %s", user_id, user_message)

        session_manager = SessionManager()
        session_data = session_manager.get_session(user_id)
        
        # ì¬ê°œ í™•ì¸ì´ í•„ìš”í•œ ê²½ìš°
        if session_manager.needs_resume_check(session_data) and not session_data.get('awaiting_resume_response', False):
            # ëŒ€í™” ë‚´ìš© ìš”ì•½
            summary = get_conversation_summary(session_data.get('conversation_history', []))
            
            # ì¬ê°œ í™•ì¸ ë©”ì‹œì§€ ì„¤ì •
            coach_response = f"ì•ˆë…•í•˜ì„¸ìš”! ë‹¤ì‹œ ë§Œë‚˜ì„œ ë°˜ê°‘ìŠµë‹ˆë‹¤. ğŸ˜Š\n\nìš°ë¦¬ê°€ ë§ˆì§€ë§‰ì— '{summary}'ì— ëŒ€í•´ ì´ì•¼ê¸°í•˜ê³  ìˆì—ˆëŠ”ë°ìš”, ì´ì–´ì„œ ê³„ì† ì§„í–‰í•˜ì‹œê² ì–´ìš”? ì•„ë‹ˆë©´ ìƒˆë¡œìš´ ì£¼ì œë¡œ ì‹œì‘í•˜ì‹œê² ì–´ìš”?"
            
            # ì¬ê°œ ì‘ë‹µ ëŒ€ê¸° ìƒíƒœë¡œ ì„¤ì •
            session_data['awaiting_resume_response'] = True
            session_manager.update_session(session_data)
            
            response_body = {
                "version": "2.0",
                "template": {
                    "outputs": [
                        {
                            "simpleText": {
                                "text": coach_response
                            }
                        }
                    ]
                }
            }
            
            return {
                "statusCode": 200,
                "body": json.dumps(response_body, ensure_ascii=False),
                "headers": {"Content-Type": "application/json; charset=utf-8"}
            }
        
        # ì¬ê°œ ì‘ë‹µ ëŒ€ê¸° ì¤‘ì¸ ê²½ìš°
        if session_data.get('awaiting_resume_response', False):
            session_data['awaiting_resume_response'] = False
            
            if check_new_session_keywords(user_message) or check_reset_keywords(user_message):
                # ìƒˆ ì„¸ì…˜ ì‹œì‘
                session_data = session_manager.reset_session(user_id)
                user_message = "ì•ˆë…•í•˜ì„¸ìš”, ì½”ì¹­ì„ ì‹œì‘í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤."
                logger.info("New session started after resume check")
            else:
                # ê¸°ì¡´ ì„¸ì…˜ ê³„ì†
                logger.info("Continuing previous session")
        
        # ì¼ë°˜ì ì¸ ë¦¬ì…‹/ì¢…ë£Œ í‚¤ì›Œë“œ ì²´í¬
        elif check_reset_keywords(user_message):
            session_data = session_manager.reset_session(user_id)
            user_message = "ì•ˆë…•í•˜ì„¸ìš”, ì½”ì¹­ì„ ì‹œì‘í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤."
            logger.info("Session reset triggered by user")
        elif check_end_keywords(user_message):
            # ì¢…ë£Œ ì‹œ ì„¸ì…˜ ì €ì¥
            if len(session_data.get('conversation_history', [])) > 0:
                session_manager.save_completed_session(session_data)
            
            # ì¢…ë£Œ ì‘ë‹µ ìƒì„±
            coach_response = "ì˜¤ëŠ˜ í•¨ê»˜ ì´ì•¼ê¸° ë‚˜ëˆ ì¤˜ì„œ ì •ë§ ê³ ë§ˆì›Œìš”. ë„ì›€ì´ í•„ìš”í•  ë•Œ ìš©ê¸°ë‚´ì„œ ì†ì„ ë‚´ë°€ ìˆ˜ ìˆë‹¤ëŠ” ê±¸ ê¸°ì–µí•´ì£¼ì„¸ìš”. ì–¸ì œë“ ì§€ ë‹¤ì‹œ ì´ì•¼ê¸° ë‚˜ëˆ„ê³  ì‹¶ìœ¼ë©´ 'ë‹¤ì‹œ ì‹œì‘'ì´ë¼ê³  ë§í•´ì£¼ì„¸ìš”. ì‘ì›í• ê²Œìš”! ğŸ’ªğŸ˜Š"
            
            response_body = {
                "version": "2.0",
                "template": {
                    "outputs": [
                        {
                            "simpleText": {
                                "text": coach_response
                            }
                        }
                    ]
                }
            }
            
            return {
                "statusCode": 200,
                "body": json.dumps(response_body, ensure_ascii=False),
                "headers": {"Content-Type": "application/json; charset=utf-8"}
            }
        
        # ìœ„ê¸° í‚¤ì›Œë“œ ì²´í¬
        if check_crisis_keywords(user_message):
            session_data['crisis_detected'] = True
            session_data['crisis_timestamp'] = datetime.utcnow().isoformat()
            logger.warning(f"Crisis keywords detected for user {user_id}")
        
        if not isinstance(session_data, dict):
            logger.error("session_dataê°€ dictê°€ ì•„ë‹˜: %s", type(session_data))
            session_data = session_manager.create_new_session(user_id)

        conversation_history = session_data.get('conversation_history', [])
        if not isinstance(conversation_history, list):
            logger.error("conversation_historyê°€ ë¦¬ìŠ¤íŠ¸ê°€ ì•„ë‹˜, ì´ˆê¸°í™”")
            conversation_history = []

        # ì„¸ì…˜ì— ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        session_data['conversation_history'].append({"role": "user", "content": user_message})

        # í˜„ì¬ ë‹¨ê³„ ë° ì§ˆë¬¸ ì¹´ìš´íŠ¸ ê°€ì ¸ì˜¤ê¸°
        current_stage = int(session_data.get('current_stage', 0))
        stage_question_count = int(session_data.get('stage_question_count', 0))
        
        # ë‹¨ê³„ë³„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì„¤ì •
        stage_name = COACHING_STAGES[current_stage]
        
        # ì²« ë‹¨ê³„ì´ê³  ì²« ì§ˆë¬¸ì¸ ê²½ìš° ì´ì „ ì„¸ì…˜ ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€
        previous_context = ""
        if current_stage == 0 and stage_question_count == 0:
            previous_context = get_previous_context(user_id, session_manager)
        
        # í•™ìƒ ëŒ€ìƒ í”„ë¡¬í”„íŠ¸ ì¶”ê°€
        system_prompt = f"""
{STAGE_PROMPTS[stage_name].format(previous_context=previous_context)}

í˜„ì¬ ë‹¨ê³„: {stage_name} ({current_stage + 1}/{len(COACHING_STAGES)})
ì§ˆë¬¸ íšŸìˆ˜: {stage_question_count + 1}ë²ˆì§¸

ì¤‘ìš”í•œ ì½”ì¹­ ì›ì¹™:
1. í•™ìƒì˜ ë‹µë³€ì„ ê¹Šì´ íŒŒê³ ë“¤ì§€ ë§ê³ , ë‹¨ê³„ì˜ ëª©í‘œì— ë§ëŠ” ìƒˆë¡œìš´ ì§ˆë¬¸ìœ¼ë¡œ ì „í™˜í•˜ì„¸ìš”
2. ê°™ì€ ì£¼ì œë¥¼ ë°˜ë³µí•´ì„œ ë¬»ì§€ ë§ˆì„¸ìš”
3. í•™ìƒì´ ì¶©ë¶„íˆ ë‹µí–ˆë‹¤ë©´ ë‹¤ìŒ ê´€ì ì˜ ì§ˆë¬¸ìœ¼ë¡œ ë„˜ì–´ê°€ì„¸ìš”
4. ë‹¨ê³„ë³„ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ê¸° ìœ„í•œ í•µì‹¬ ì§ˆë¬¸ì„ í•˜ì„¸ìš”
5. í•™ìƒì˜ ë‹µë³€ì´ ì§§ì•„ë„ ê³„ì† íŒŒê³ ë“¤ì§€ ë§ê³  ë‹¤ë¥¸ ê°ë„ì˜ ì§ˆë¬¸ì„ í•˜ì„¸ìš”

âš ï¸ ì¶œë ¥ ê·œì¹™ (ë°˜ë“œì‹œ ì¤€ìˆ˜):
1. ë”± í•œ ê°œì˜ ì§ˆë¬¸ë§Œ ì¶œë ¥
2. ì ˆëŒ€ ë‘ ë²ˆì§¸ ì§ˆë¬¸ ê¸ˆì§€
3. ê´„í˜¸ ì•ˆì— ì•„ë¬´ê²ƒë„ ì“°ì§€ ë§ˆì„¸ìš”
4. ë§ˆë¬´ë¦¬ ë‹¨ê³„ê°€ ì•„ë‹ˆë©´ ë§ˆë¬´ë¦¬ ë©˜íŠ¸ ê¸ˆì§€
5. í˜„ì¬ ë‹¨ê³„ì— ë§ëŠ” ì§ˆë¬¸ë§Œ í•˜ì„¸ìš”

ì´ì „ ì§ˆë¬¸ê³¼ ì¤‘ë³µë˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ì„¸ìš”.
"""
        
        # ì‹œê°„ ì²´í¬ ì¶”ê°€
        session_duration = session_manager.get_session_duration(session_data)
        if session_duration >= SESSION_TIME_LIMIT_MINUTES:
            system_prompt += f"\n\nì„¸ì…˜ì´ {SESSION_TIME_LIMIT_MINUTES}ë¶„ì„ ë„˜ì–´ê°”ìŠµë‹ˆë‹¤. ëŒ€í™”ë¥¼ ë§ˆë¬´ë¦¬í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”."
        
        # Upstage Solar Pro2 API í˜¸ì¶œ
        coach_response = call_upstage_solar_api(
            session_data['conversation_history'],
            system_prompt=system_prompt
        )
        
        if not coach_response:
            coach_response = "ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."
        
        # ìœ„ê¸° ìƒí™©ì¼ ê²½ìš° ë„ì›€ ìì› ì•ˆë‚´ ì¶”ê°€
        if session_data.get('crisis_detected', False) and stage_question_count % 2 == 0:
            coach_response += "\n\nğŸ’™ í˜ë“  ë§ˆìŒì„ í‘œí˜„í•´ì¤˜ì„œ ì •ë§ ê³ ë§ˆì›Œìš”. í˜¼ìê°€ ì•„ë‹ˆì—ìš”. ë‹´ì„ì„ ìƒë‹˜ì´ë‚˜ ìƒë‹´ì„ ìƒë‹˜, ë˜ëŠ” ì²­ì†Œë…„ìƒë‹´ 1388ì— ì—°ë½í•´ë³´ëŠ” ê²ƒë„ ì¢‹ì€ ë°©ë²•ì´ì—ìš”."
        
        # ì‹œê°„ ì œí•œ ì•ˆë‚´
        if session_duration >= SESSION_TIME_LIMIT_MINUTES - 2 and session_duration < SESSION_TIME_LIMIT_MINUTES:
            coach_response += "\n\nâ° ê³§ ëŒ€í™” ì‹œê°„ì´ ë§ˆë¬´ë¦¬ë©ë‹ˆë‹¤. ì˜¤ëŠ˜ ë‚˜ëˆˆ ì´ì•¼ê¸° ì¤‘ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ì„ ìƒê°í•´ë³´ì„¸ìš”."
        
        # ì½”ì¹˜ ì‘ë‹µ ì €ì¥
        session_data['conversation_history'].append({"role": "assistant", "content": coach_response})
        
        # ì§ˆë¬¸ ì¹´ìš´íŠ¸ ì¦ê°€
        session_data['stage_question_count'] = int(session_data.get('stage_question_count', 0)) + 1
        
        # ë‹¨ê³„ ì „í™˜ ë¡œì§ (ë©”ì‹œì§€ ì¶”ê°€ ì—†ì´)
        if should_advance_stage(session_data, user_message):
            next_stage = current_stage + 1
            
            if next_stage < len(COACHING_STAGES):
                # ë‹¤ìŒ ë‹¨ê³„ë¡œ ì „í™˜
                session_data['current_stage'] = next_stage
                session_data['stage_question_count'] = 0
                
                # ë‹¨ê³„ ì „í™˜ ì‹œ ë¶€ë“œëŸ¬ìš´ ì—°ê²° ë©”ì‹œì§€ ì¶”ê°€
                transition_messages = {
                    "í˜„ì‹¤ íƒìƒ‰": "ê·¸ë ‡êµ°ìš”. ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ ì´ì•¼ê¸°í•´ë³¼ê¹Œìš”?",
                    "ëª©í‘œ ì„¤ì •": "ìƒí™©ì„ ì˜ ì´í•´í–ˆì–´ìš”. ì´ì œ ì›í•˜ëŠ” ë³€í™”ì— ëŒ€í•´ ìƒê°í•´ë´ìš”.",
                    "ëŒ€ì•ˆ íƒìƒ‰": "ëª©í‘œê°€ ëª…í™•í•´ì¡Œë„¤ìš”. ë„ì›€ë°›ì„ ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì°¾ì•„ë´ìš”.",
                    "ì‹¤í–‰ ê³„íš": "ì¢‹ì€ ë°©ë²•ë“¤ì´ ìˆë„¤ìš”. êµ¬ì²´ì ì¸ ê³„íšì„ ì„¸ì›Œë´ìš”.",
                    "ì •ë¦¬ ë° ë§ˆë¬´ë¦¬": "ë§ì€ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ´ë„¤ìš”. ì˜¤ëŠ˜ ëŒ€í™”ë¥¼ ì •ë¦¬í•´ë´ìš”."
                }
                
                next_stage_name = COACHING_STAGES[next_stage]
                if next_stage_name in transition_messages:
                    coach_response = transition_messages[next_stage_name] + "\n\n" + coach_response
                
                logger.info(f"Stage advanced from {current_stage} to {next_stage}")
            else:
                # ëª¨ë“  ë‹¨ê³„ê°€ ì™„ë£Œëœ ê²½ìš°
                completion_message = f"\n\nğŸ‰ ì˜¤ëŠ˜ ì •ë§ ì˜ë¯¸ìˆëŠ” ëŒ€í™”ë¥¼ ë‚˜ëˆ´ì–´ìš”! ë„ì›€ì´ í•„ìš”í•  ë•Œ ìš©ê¸°ë‚´ì„œ ë§í•  ìˆ˜ ìˆëŠ” ì—¬ëŸ¬ë¶„ì´ ì •ë§ ë©‹ì ¸ìš”. ìƒˆë¡œìš´ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ê³  ì‹¶ìœ¼ë©´ 'ë‹¤ì‹œ ì‹œì‘'ì´ë¼ê³  ë§í•´ì£¼ì„¸ìš”."
                coach_response += completion_message
                
                # ì™„ë£Œëœ ì„¸ì…˜ ì €ì¥
                session_manager.save_completed_session(session_data)
                
                logger.info("All coaching stages completed")
        
        # ì„¸ì…˜ ì—…ë°ì´íŠ¸
        session_manager.update_session(session_data)

        # ì¹´ì¹´ì˜¤í†¡ ì‘ë‹µ ìƒì„±
        response_body = {
            "version": "2.0",
            "template": {
                "outputs": [
                    {
                        "simpleText": {
                            "text": coach_response
                        }
                    }
                ]
            }
        }
        
        # ë””ë²„ê¹… ì •ë³´ ë¡œê¹…
        logger.info(f"Current stage: {int(session_data.get('current_stage', 0))} ({COACHING_STAGES[int(session_data.get('current_stage', 0))]})")
        logger.info(f"Question count: {int(session_data.get('stage_question_count', 0))}")
        logger.info(f"Session duration: {session_duration} minutes")
        logger.info(f"Crisis detected: {session_data.get('crisis_detected', False)}")
        logger.info(f"Response: {coach_response[:100]}...")

        return {
            "statusCode": 200,
            "body": json.dumps(response_body, ensure_ascii=False),
            "headers": {"Content-Type": "application/json; charset=utf-8"}
        }
        
    except Exception as e:
        logger.error(f"Error in lambda_handler: {str(e)}", exc_info=True)
        error_response = {
            "version": "2.0",
            "template": {
                "outputs": [
                    {
                        "simpleText": {
                            "text": "ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
                        }
                    }
                ]
            }
        }
        return {
            'statusCode': 200,
            'body': json.dumps(error_response, ensure_ascii=False),
            'headers': {
                'Content-Type': 'application/json; charset=utf-8'
            }
        }
